<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Isabella ‚ú® 15 A√±os</title>
  <style>
    :root{
      --bg1:#fff7fb;
      --bg2:#f2fbff;
      --card:#ffffffcc;
      --ink:#2b2b2b;
      --muted:#6b6b6b;
      --pink:#ff5fa2;
      --violet:#8a5cff;
      --mint:#35d6c2;
      --shadow: 0 18px 50px rgba(0,0,0,.12);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink)}
    body{
      background:
        radial-gradient(1200px 800px at 20% 0%, #ffd7ea 0%, transparent 60%),
        radial-gradient(1000px 700px at 100% 20%, #d6f4ff 0%, transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }
    .wrap{ min-height:100%; display:flex; align-items:center; justify-content:center; padding:20px 16px 28px; }
    .app{ width:min(980px, 100%); display:grid; grid-template-columns: 1.05fr .95fr; gap:16px; }
    @media (max-width: 860px){ .app{grid-template-columns:1fr; gap:14px;} }

    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.55);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding:18px;
      position:relative;
      overflow:hidden;
    }

    .titleRow{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:linear-gradient(90deg, rgba(255,95,162,.18), rgba(138,92,255,.16));
      border:1px solid rgba(255,95,162,.22);
      font-weight:800;
    }
    .spark{width:12px; height:12px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, #ffd6f0 35%, #ff5fa2 75%, #8a5cff 100%);
      box-shadow:0 0 18px rgba(255,95,162,.55);
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.25)} }

    h1{ margin:0; font-size: clamp(22px, 4vw, 34px); letter-spacing:.2px; }
    .sub{ margin:6px 0 0; color:var(--muted); line-height:1.35; font-size: 14.5px; }

    .progress{ margin-top:14px; display:flex; align-items:center; gap:10px; }
    .bar{ flex:1; height:10px; background:rgba(0,0,0,.07); border-radius:999px; overflow:hidden; }
    .bar > i{ display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--pink), var(--violet), var(--mint)); border-radius:999px; transition: width .35s ease; }
    .pct{ min-width:64px; text-align:right; font-weight:900; color:rgba(43,43,43,.8); }

    .msgBox{ margin-top:14px; padding:16px; border-radius:18px; background:rgba(255,255,255,.85); border:1px dashed rgba(255,95,162,.35); position:relative; }
    .msgBox .label{ display:flex; align-items:center; gap:8px; font-weight:950; margin-bottom:10px; color:rgba(43,43,43,.9); }
    .msgBox .label .heart{ width:14px; height:14px; transform: rotate(45deg); background:linear-gradient(135deg, var(--pink), var(--violet)); border-radius:4px; position:relative; }
    .msgBox .label .heart:before,
    .msgBox .label .heart:after{ content:""; position:absolute; width:14px; height:14px; background:inherit; border-radius:50%; top:-7px; left:0; }
    .msgBox .label .heart:after{ left:-7px; top:0; }

    .message{ min-height:92px; font-size: 16px; line-height: 1.5; margin:0; word-break: break-word; }
    .message .chip{
      display:inline-block;
      margin:4px 6px 0 0;
      padding:6px 10px;
      border-radius:999px;
      background:linear-gradient(90deg, rgba(255,95,162,.16), rgba(138,92,255,.12));
      border:1px solid rgba(255,95,162,.22);
      animation: pop .26s ease-out;
      font-weight:800;
    }
    @keyframes pop{ from{ transform: scale(.9); opacity:.35 } to{ transform: scale(1); opacity:1 } }

    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; }
    .chips .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:linear-gradient(90deg, rgba(255,95,162,.16), rgba(138,92,255,.12));
      border:1px solid rgba(255,95,162,.22);
      animation: pop .26s ease-out;
      font-weight:850;
      font-size: 13.5px;
      color: rgba(43,43,43,.86);
    }

    /* (compat) Si existiera alg√∫n chip dentro del p√°rrafo, no se muestra */
    .message .chip{ display:none; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px; }
    @media (max-width: 520px){
      .grid{grid-template-columns:1fr;}
      button{ padding:14px 14px; font-size:16px; border-radius:18px; }
      .card{ padding:16px; }
      .msgBox{ padding:14px; }
      .message{ font-size:16px; }
    }

    button{
      appearance:none;
      border:0;
      width:100%;
      text-align:left;
      padding:12px 12px;
      border-radius:16px;
      background:rgba(255,255,255,.86);
      border:1px solid rgba(0,0,0,.06);
      box-shadow: 0 10px 22px rgba(0,0,0,.06);
      color:var(--ink);
      font-weight:900;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
      position:relative;
      overflow:hidden;
    }
    button:active{ transform: translateY(1px) scale(.99); }
    button:hover{ box-shadow: 0 14px 28px rgba(0,0,0,.08); }
    button[disabled]{ opacity:.45; cursor:not-allowed; }

    .kemoji{font-size:18px; margin-right:8px}
    .hint{ margin-top:10px; font-size: 13px; color: var(--muted); }

    .scene{ height:100%; min-height: 420px; display:flex; flex-direction:column; justify-content:space-between; position:relative; }
    .big{ display:grid; gap:10px; align-content:start; }
    .poster{
      border-radius: 22px;
      padding:16px;
      background:linear-gradient(135deg, rgba(255,95,162,.20), rgba(138,92,255,.14), rgba(53,214,194,.12));
      border:1px solid rgba(255,255,255,.55);
      box-shadow: 0 18px 50px rgba(0,0,0,.10);
      position:relative;
      overflow:hidden;
    }
    .poster h2{ margin:0; font-size: clamp(20px, 3.5vw, 28px); letter-spacing:.2px; }
    .poster p{ margin:8px 0 0; color:rgba(43,43,43,.75); line-height:1.4; font-weight:750; }

    .cta{
      flex:1;
      min-width: 140px;
      text-align:center;
      background:linear-gradient(90deg, rgba(255,95,162,.22), rgba(138,92,255,.20));
      border:1px solid rgba(255,95,162,.25);
      font-weight:950;
    }
    .cta.secondary{ background:rgba(255,255,255,.78); border:1px solid rgba(0,0,0,.06); }

    .floatLayer{ position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index: 30; }

    /* Burbujitas de charla (modo Isabella) */
    .bubbleLayer{ position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index: 31; }
    .bubble{
      position:absolute;
      max-width: min(320px, 78vw);
      padding:10px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,95,162,.22);
      box-shadow: 0 16px 34px rgba(0,0,0,.12);
      font-weight: 900;
      color: rgba(43,43,43,.85);
      transform: translateY(10px) scale(.98);
      opacity: 0;
      animation: bubbleInOut 2.4s ease forwards;
    }
    .bubble:after{
      content:"";
      position:absolute;
      left:18px;
      bottom:-10px;
      width:18px; height:18px;
      background: inherit;
      border-left:1px solid rgba(255,95,162,.18);
      border-bottom:1px solid rgba(255,95,162,.18);
      transform: rotate(45deg);
      border-bottom-left-radius: 6px;
    }
    @keyframes bubbleInOut{
      0%{opacity:0; transform: translateY(14px) scale(.98)}
      12%{opacity:1; transform: translateY(0) scale(1)}
      80%{opacity:1}
      100%{opacity:0; transform: translateY(-10px) scale(.98)}
    }

    .floatHeart{
      position:absolute;
      width:14px; height:14px;
      transform: rotate(45deg);
      background:linear-gradient(135deg, var(--pink), var(--violet));
      border-radius:4px;
      opacity:.9;
      filter: drop-shadow(0 10px 16px rgba(255,95,162,.25));
      animation: floatUp linear forwards;
    }
    .floatHeart:before, .floatHeart:after{ content:""; position:absolute; width:14px; height:14px; background:inherit; border-radius:50%; top:-7px; left:0; }
    .floatHeart:after{ left:-7px; top:0; }
    @keyframes floatUp{
      from{ transform: translateY(0) rotate(45deg) scale(.95); opacity:.0 }
      10%{ opacity:.9 }
      to{ transform: translateY(-120vh) rotate(45deg) scale(1.25); opacity:0 }
    }

    .overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(20, 12, 22, .45);
      z-index: 40;
      padding: 18px;
    }
    .overlay.show{ display:flex; }
    .finalCard{
      width:min(720px, 100%);
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.55);
      border-radius: 26px;
      box-shadow: 0 24px 80px rgba(0,0,0,.22);
      overflow:hidden;
      position:relative;
    }
    .finalTop{ padding:18px 18px 10px; background: linear-gradient(135deg, rgba(255,95,162,.22), rgba(138,92,255,.18), rgba(53,214,194,.14)); }
    .finalTop h3{ margin:0; font-size: clamp(20px, 4vw, 30px); }
    .finalBody{ padding:16px 18px 18px; }
    .finalMsg{ margin:0; font-size: 18px; line-height: 1.55; font-weight: 800; }
    .finalBtns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    .finalBtns button{ text-align:center; font-weight:980; }
    canvas#confetti{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; }

    .footer{ text-align:center; font-size:12.5px; color:rgba(43,43,43,.55); margin-top:10px; }
  </style>
</head>

<body>
  <div class="floatLayer" id="floatLayer" aria-hidden="true"></div>
  <div class="bubbleLayer" id="bubbleLayer" aria-hidden="true"></div>

  <div class="wrap">
    <div class="app">

      <section class="card" id="gameCard">
        <div class="titleRow">
          <div>
            <h1>üíñ Juego Kawaii para Isabella</h1>
            <p class="sub">Princesita: toc√° frases para armar un mensaje de amor. Cuando completes el coraz√≥n‚Ä¶ ¬°hay sorpresa! ‚ú®</p>
          </div>
          <div class="badge"><span class="spark"></span> 15 A√±os</div>
        </div>

        <div class="progress" aria-label="Progreso">
          <div class="bar"><i id="barFill"></i></div>
          <div class="pct" id="pct">0%</div>
        </div>

        <div class="msgBox">
          <div class="label"><span class="heart"></span> Tu mensaje se arma as√≠:</div>
          <p class="message" id="message"></p>
          <div id="chips" class="chips" aria-label="Frases elegidas"></div>
          <div class="hint" id="hint">Tip: toc√° 6‚Äì8 frases para que quede perfecto üòä</div>
        </div>

        <div class="grid" id="buttons"></div>

        <div class="hint">Funciona sin internet. Ideal para abrirlo en el hotel desde el tel√©fono üè®</div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button id="btnFinalInline" class="cta" style="display:none;text-align:center;min-width:180px">‚ú® Ver final</button>
          <button id="btnResetInline" class="cta secondary" style="text-align:center;min-width:140px">üîÑ Reiniciar</button>
        </div>

        <div class="footer">Hecho con üíó para Isabella (mi princesita).</div>
      </section>

      <aside class="card scene">
        <div class="big">
          <div class="poster">
            <h2>üå∏ Isabella, mi princesita üå∏</h2>
            <p>
              Este jueguito es un regalo chiquito, pero con un mensaje gigante.
              Porque tu mam√° y yo trabajamos mucho para traerte de Venezuela a Argentina,
              para una vida llena de oportunidades, arte y sue√±os.
            </p>

            <div style="margin-top:12px;padding:12px 12px;border-radius:18px;background:rgba(255,255,255,.70);border:1px solid rgba(0,0,0,.06)">
              <div style="font-weight:950;margin-bottom:8px">üìú C√≥mo se juega</div>
              <div style="display:grid;gap:6px;color:rgba(43,43,43,.78);font-weight:750;line-height:1.35">
                <div>1) Toc√° botones de frases para armar tu mensaje üíó</div>
                <div>2) Cuando llegues a <b>7 frases</b>, aparece <b>‚ú® Ver final</b> (abajo)</div>
                <div>3) Si toc√°s <b>Zeus ‚ö°</b> y despu√©s <b>Talasofobia üåä</b>‚Ä¶ ¬°combo secreto! üòÑ</div>
              </div>
            </div>

            <div class="footer" style="margin-top:12px">Tip: el combo secreto es Zeus ‚ö° + Talasofobia üåä</div>
          </div>
        </div>

        <div class="footer">Modo Isabella: burbujitas üí¨ + ocurrencias XD</div>
      </aside>

    </div>
  </div>

  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-label="Mensaje final">
    <div class="finalCard">
      <canvas id="confetti"></canvas>
      <div class="finalTop">
        <h3>üéâ ¬°Feliz cumplea√±os, Isabella! üéâ</h3>
      </div>
      <div class="finalBody">
        <p class="finalMsg" id="finalMsg"></p>
        <div class="finalBtns">
          <button id="btnCopy">üìã Copiar mensaje</button>
          <button id="btnClose" class="cta secondary">Cerrar</button>
          <button id="btnReset2" class="cta secondary">Reiniciar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Frases kawaii + detalles personales
    const phrases = [
      // Las frases base (las que me pasaste)
      { emoji:"üëë", text:"Mi princesita" },
      { emoji:"‚ú®", text:"Eres mi orgullo" },
      { emoji:"üå∑", text:"Tu sonrisa me ilumina" },
      { emoji:"ü´∂", text:"Gracias por elegirme" },
      { emoji:"üåü", text:"Eres una luz en mi vida" },
      { emoji:"üß∏", text:"Siempre voy a cuidarte" },
      { emoji:"üéÄ", text:"Eres dulce y valiente" },
      { emoji:"üíé", text:"Tu coraz√≥n es enorme" },
      { emoji:"üé®", text:"Amas el arte y lo llevas por dentro" },
      { emoji:"üíÉ", text:"Cuando bailas, el mundo se vuelve m√°s bonito" },
      { emoji:"üó£Ô∏è", text:"Hablas hasta por los codos (¬°y me encanta!)" },
      { emoji:"üí°", text:"Eres ocurrente: siempre sorprendes" },
      { emoji:"ü™ê", text:"Tu imaginaci√≥n inventa mundos locos" },
      { emoji:"üîé", text:"Te encanta investigar cosas raras y geniales" },
      { emoji:"‚ö°", text:"Zeus estar√≠a orgulloso de tu curiosidad" },
      { emoji:"üåä", text:"Incluso la talasofobia no te detiene" },
      { emoji:"üáªüá™", text:"De Venezuela trajiste tu fuerza" },
      { emoji:"üá¶üá∑", text:"En Argentina est√°s construyendo tus sue√±os" },
      { emoji:"ü§ç", text:"Tu mam√° y yo trabajamos mucho por tu felicidad" },
      { emoji:"üß°", text:"Desde que ten√≠as 4 a√±os" },
      { emoji:"üß≠", text:"Caminamos juntos y no nos separamos" },
      { emoji:"üåà", text:"Siempre quiero verte feliz" },
      { emoji:"ü•π", text:"Te amo con todo mi coraz√≥n" },

      // Extras de Austin & Ally (el recuerdo del carro y la casa üòÑ)
      { emoji:"üì∫", text:"De chiquita amabas Austin & Ally" },
      { emoji:"üé∏", text:"Austin Moon iba contigo en el carro (modo imaginaci√≥n)" },
      { emoji:"üöó", text:"Yo: 'Austin, b√°jate del carro' üòÇ" },
      { emoji:"üè†", text:"Y yo lo corr√≠a de la casa (en broma) ü§£" }
    ];

    const FINAL_LINE = "Feliz cumplea√±os, hija hermosa. Te amo y espero seguir siendo tu padre para toda la vida.";

    const picked = [];
    const targetMin = 7;
    const targetMax = 9;

    const buttonsWrap = document.getElementById("buttons");
    const messageEl = document.getElementById("message");
    const chipsEl = document.getElementById("chips");
    const barFill = document.getElementById("barFill");
    const pctEl = document.getElementById("pct");
    const hintEl = document.getElementById("hint");
    const overlay = document.getElementById("overlay");
    const finalMsgEl = document.getElementById("finalMsg");
    const floatLayer = document.getElementById("floatLayer");
    const bubbleLayer = document.getElementById("bubbleLayer");
    const btnFinal = document.getElementById("btnFinalInline");
    const btnReset = document.getElementById("btnResetInline");
    const btnReset2 = document.getElementById("btnReset2");
    const btnClose = document.getElementById("btnClose");
    const btnCopy = document.getElementById("btnCopy");

    function shuffle(arr){
      const a = arr.slice();
      for (let i=a.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function renderButtons(){
      buttonsWrap.innerHTML = "";
      const list = shuffle(phrases);
      list.forEach((p) => {
        const b = document.createElement("button");
        b.innerHTML = `<span class="kemoji">${p.emoji}</span>${p.text}`;
        b.addEventListener("click", () => pickPhrase(p, b));
        buttonsWrap.appendChild(b);
      });
    }

    // --- Soniditos (sin archivos externos) ---
    let audioCtx = null;
    function getAudio(){
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }
    function beep({freq=660, dur=0.06, type='sine', gain=0.045, slideTo=null}={}){
      const ac = getAudio();
      const o = ac.createOscillator();
      const g = ac.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, ac.currentTime);
      if (slideTo) o.frequency.exponentialRampToValueAtTime(slideTo, ac.currentTime + dur);
      g.gain.setValueAtTime(0.0001, ac.currentTime);
      g.gain.exponentialRampToValueAtTime(gain, ac.currentTime + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + dur);
      o.connect(g); g.connect(ac.destination);
      o.start(); o.stop(ac.currentTime + dur);
    }
    function popSound(){ beep({freq:520, slideTo:780, dur:0.07, type:'triangle', gain:0.05}); }
    function sparkleSound(){
      beep({freq:880, slideTo:1320, dur:0.08, type:'sine', gain:0.04});
      setTimeout(()=>beep({freq:1320, slideTo:990, dur:0.07, type:'sine', gain:0.03}), 45);
    }

    function showBubble(text){
      if (!bubbleLayer) return;
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;

      // Posici√≥n: alrededor del centro (m√°s "chat")
      const w = window.innerWidth;
      const h = window.innerHeight;
      const x = Math.max(12, Math.min(w - 340, (w*0.18) + Math.random()*(w*0.64)));
      const y = Math.max(90, Math.min(h - 220, (h*0.22) + Math.random()*(h*0.30)));
      b.style.left = x + 'px';
      b.style.top = y + 'px';

      bubbleLayer.appendChild(b);
      setTimeout(()=> b.remove(), 2500);
    }

    const bubblePhrases = [
      'XD ‚ú®',
      '¬øY si inventamos un unicornio astronauta? ü¶ÑüöÄ',
      'Plot twist: ¬°princesita detective! üëëüîé',
      'Dato random: hoy bailo y brillo üíÉüåü',
      'Modo curiosidad activado üîéüí°',
      'Yo hablando hasta por los codos‚Ä¶ üó£Ô∏èüòÇ',
      '¬øZeus? ok‚Ä¶ pero con glitter ‚ö°‚ú®',
      'Talasofobia: miedo + valent√≠a = yo üåäü´∂',
      'Mi cerebro: mil ideas por minuto ü™êüí´',
      'Austin Moon en el carro‚Ä¶ confirmado üòÖüé∏',
      'Pap√°: "Austin, b√°jate del carro" üöóü§£',
      'Yo: "Austin, salga de mi casa" üè†üòÇ',
      'Isabella: "Pap√°, √©l vive conmigo" üò≠üíó'
    ];

    function maybeBubble(trigger){
      const t = (trigger || '').toLowerCase();
      const boost = (
        t.includes('codos') || t.includes('ocurrente') || t.includes('imaginaci√≥n') ||
        t.includes('investigar') || t.includes('zeus') || t.includes('talaso') ||
        t.includes('austin') || t.includes('ally')
      );
      const chance = boost ? 0.88 : 0.42;

      // Mini-evento Austin & Ally
      if (t.includes('austin')){
        showBubble('üöó Pap√°: "Austin, b√°jate del carro" üòÇ');
        setTimeout(()=>showBubble('üé∏ Austin Moon: "ok ok" üòÖ'), 520);
        burstHearts(10);
        sparkleSound();
        return;
      }

      if (Math.random() < chance){
        const pick = bubblePhrases[Math.floor(Math.random()*bubblePhrases.length)];
        showBubble(pick);
      }
    }

    function pickPhrase(p, btn){
      if (picked.length >= targetMax) return;
      picked.push(p);
      btn.disabled = true;

      const chip = document.createElement("span");
      chip.className = "chip";
      chip.textContent = `${p.emoji} ${p.text}`;
      chipsEl.appendChild(chip);

      updatePreview();

      burstHearts(8);
      popSound();
      maybeBubble(p.text);
      updateProgress();

      // Secret combo: Zeus + Talasofobia => extra hearts
      const texts = picked.map(x => x.text.toLowerCase());
      if (texts.some(t=>t.includes("zeus")) && texts.some(t=>t.includes("talaso"))){
        burstHearts(18);
        hintEl.textContent = "¬°Combo secreto activado! ‚ö°üåä (Isabella investigadora mode) ‚ú®";
        sparkleSound();
      }

      if (picked.length >= targetMin){
        btnFinal.disabled = false;
        btnFinal.style.display = "inline-block";
        if (!hintEl.textContent.includes("Combo secreto"))
          hintEl.textContent = "¬°Ya casi! Pod√©s seguir agregando‚Ä¶ o tocar ‚ú® Ver final üíñ";
      }

      if (picked.length === targetMax){
        btnFinal.disabled = false;
        if (!hintEl.textContent.includes("Combo secreto"))
          hintEl.textContent = "¬°Perfecto! Ahora s√≠: toc√° ‚ÄúVer final‚Äù ‚ú®";
      }
    }

    function updateProgress(){
      const pct = Math.round((picked.length / targetMax) * 100);
      barFill.style.width = `${pct}%`;
      pctEl.textContent = `${pct}%`;
    }

    function resetGame(){
      picked.length = 0;
      messageEl.textContent = "";
      chipsEl.innerHTML = "";
      barFill.style.width = "0%";
      pctEl.textContent = "0%";
      hintEl.textContent = "Tip: toc√° 6‚Äì8 frases para que quede perfecto üòä";
      btnFinal.disabled = true;
      btnFinal.style.display = "none";

      renderButtons();
      burstHearts(12);
    }

    function burstHearts(n=6){
      const w = window.innerWidth;
      for (let i=0;i<n;i++){
        const h = document.createElement("div");
        h.className = "floatHeart";
        const x = Math.random()*w;
        const dur = 1700 + Math.random()*1600;
        h.style.left = `${x}px`;
        h.style.bottom = `-20px`;
        h.style.animationDuration = `${dur}ms`;
        h.style.opacity = "0";
        floatLayer.appendChild(h);
        setTimeout(()=> h.remove(), dur+50);
      }
    }

    function squeezeSpaces(str){
      // sin regex (m√°s robusto para ediciones)
      let s = (str || "").trim();
      while (s.includes("  ")) s = s.replace("  ", " ");
      return s;
    }

    function normalize(t){ return (t || "").toLowerCase(); }

    function buildParagraph(includeFinal=false){
      const texts = picked.map(p => p.text);
      const tset = new Set(texts.map(normalize));
      const has = (needle) => Array.from(tset).some(x => x.includes(needle));

      const flags = {
        princesita: has('princesita'),
        orgullo: has('orgullo'),
        sonrisa: has('sonrisa'),
        gracias: has('gracias'),
        luz: has('luz'),
        cuidar: has('cuidarte'),
        dulceValiente: has('dulce') || has('valiente'),
        corazonEnorme: has('coraz√≥n') || has('corazon'),
        arte: has('arte'),
        bailar: has('bailas') || has('bailar'),
        codos: has('codos'),
        ocurrente: has('ocurrente'),
        imaginacion: has('imaginaci√≥n') || has('imaginacion'),
        investigar: has('investigar') || has('investiga'),
        zeus: has('zeus'),
        talaso: has('talaso'),
        vnz: has('venezuela'),
        arg: has('argentina'),
        trabajo: has('trabajamos'),
        since4: has('4 a√±os') || has('4'),
        juntos: has('no nos separamos') || has('caminamos juntos'),
        austin: has('austin') || has('ally')
      };

      const opener = `Isabella${flags.princesita ? ", mi princesita" : ""}, hoy cumples 15 a√±os y yo sigo con el coraz√≥n lleno de amor por ti.`;

      const compliments = [];
      if (flags.orgullo) compliments.push("Eres mi orgullo");
      if (flags.luz) compliments.push("eres una luz en mi vida");
      if (flags.sonrisa) compliments.push("tu sonrisa me ilumina");
      if (flags.corazonEnorme) compliments.push("tu coraz√≥n es enorme");
      if (flags.dulceValiente) compliments.push("eres dulce y valiente");
      if (flags.cuidar) compliments.push("siempre voy a cuidarte");
      if (flags.gracias) compliments.push("gracias por elegirme");

      let line1 = "";
      if (compliments.length){
        const first = compliments.slice(0, 2).join(", ");
        const rest = compliments.slice(2);
        line1 = rest.length ? `${first}, y ${rest.join(", ")}.` : `${first}.`;
        line1 = line1.charAt(0).toUpperCase() + line1.slice(1);
      }

      const likes = [];
      if (flags.arte) likes.push("amas el arte");
      if (flags.bailar) likes.push("cuando bailas, el mundo se vuelve m√°s bonito");
      if (flags.investigar) likes.push("te encanta investigar cosas raras y geniales");
      if (flags.zeus) likes.push("hasta Zeus estar√≠a orgulloso de tu curiosidad");
      if (flags.talaso) likes.push("y aunque el mar profundo asuste, tu valent√≠a siempre gana");
      if (flags.ocurrente) likes.push("eres ocurrente y siempre sorprendes");
      if (flags.imaginacion) likes.push("tu imaginaci√≥n inventa mundos locos");
      if (flags.codos) likes.push("hablas hasta por los codos‚Ä¶ y eso me da risa y ternura");

      let line2 = "";
      if (likes.length){
        const a = likes.slice(0, 2);
        const b = likes.slice(2);
        line2 = `Me encanta que ${a.join(" y ")}`;
        if (b.length) line2 += `, y tambi√©n que ${b.join(", ")}`;
        line2 += ".";
      }

      let line3 = "";
      if (flags.vnz || flags.arg || flags.trabajo || flags.since4 || flags.juntos){
        const p1 = (flags.trabajo || flags.vnz || flags.arg)
          ? "Tu mam√° y yo trabajamos much√≠simo para traerte de Venezuela a Argentina y darte una vida mejor."
          : "";
        const p2 = (flags.since4 || flags.juntos)
          ? "Desde que ten√≠as 4 a√±os caminamos juntos y no nos separamos."
          : "";
        line3 = [p1, p2].filter(Boolean).join(" ");
      }

      let line4 = "";
      if (flags.austin){
        line4 = "Y todav√≠a me acuerdo cuando de chiquita dec√≠as que Austin Moon iba contigo en el carro‚Ä¶ y yo, en broma, lo mandaba a bajarse y lo corr√≠a de la casa ü§£.";
      }

      const close = includeFinal ? FINAL_LINE : "";

      return squeezeSpaces([opener, line1, line2, line3, line4, close].filter(Boolean).join(" "));
    }

    function updatePreview(){
      messageEl.textContent = buildParagraph(false);
    }

    function buildFinalMessage(){
      return buildParagraph(true);
    }

    function showFinal(){
      if (picked.length < targetMin){
        burstHearts(10);
        hintEl.textContent = "Te falta un poquito üíó Toc√° algunas frases m√°s antes del final ‚ú®";
        return;
      }
      finalMsgEl.textContent = buildFinalMessage();
      overlay.classList.add("show");
      sparkleSound();
      startConfetti();
    }

    function closeFinal(){
      overlay.classList.remove("show");
      stopConfetti();
    }

    async function copyFinal(){
      try{
        await navigator.clipboard.writeText(finalMsgEl.textContent);
        btnCopy.textContent = "‚úÖ ¬°Copiado!";
        setTimeout(()=> btnCopy.textContent="üìã Copiar mensaje", 1400);
      }catch(e){
        btnCopy.textContent = "‚ö†Ô∏è No se pudo copiar";
        setTimeout(()=> btnCopy.textContent="üìã Copiar mensaje", 1400);
      }
    }

    // Confetti
    const canvas = document.getElementById("confetti");
    const ctx = canvas.getContext("2d");
    let confettiTimer = null;
    let confettiPieces = [];

    function resizeCanvas(){
      const card = canvas.parentElement.getBoundingClientRect();
      canvas.width = Math.floor(card.width * devicePixelRatio);
      canvas.height = Math.floor(card.height * devicePixelRatio);
      canvas.style.width = card.width + "px";
      canvas.style.height = card.height + "px";
      ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }

    function makeConfetti(){
      const rect = canvas.getBoundingClientRect();
      const count = 140;
      confettiPieces = Array.from({length:count}, () => ({
        x: Math.random()*rect.width,
        y: -20 - Math.random()*rect.height*0.6,
        r: 3 + Math.random()*4,
        vx: (-1 + Math.random()*2) * 1.3,
        vy: 2.3 + Math.random()*2.8,
        rot: Math.random()*Math.PI,
        vr: (-1 + Math.random()*2) * 0.07
      }));
    }

    function drawConfetti(){
      const rect = canvas.getBoundingClientRect();
      ctx.clearRect(0,0,rect.width,rect.height);
      confettiPieces.forEach(p => {
        p.x += p.vx; p.y += p.vy; p.rot += p.vr;
        if (p.y > rect.height + 30) { p.y = -20; p.x = Math.random()*rect.width; }
        if (p.x < -30) p.x = rect.width + 30;
        if (p.x > rect.width + 30) p.x = -30;

        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot);
        const g = ctx.createLinearGradient(-p.r, -p.r, p.r, p.r);
        g.addColorStop(0, "rgba(255,95,162,.95)");
        g.addColorStop(.5, "rgba(138,92,255,.9)");
        g.addColorStop(1, "rgba(53,214,194,.9)");
        ctx.fillStyle = g;
        ctx.fillRect(-p.r, -p.r, p.r*2.1, p.r*1.3);
        ctx.restore();
      });
    }

    function startConfetti(){
      resizeCanvas();
      makeConfetti();
      if (confettiTimer) return;
      confettiTimer = setInterval(drawConfetti, 16);
      window.addEventListener("resize", resizeCanvas);
    }

    function stopConfetti(){
      if (confettiTimer){
        clearInterval(confettiTimer);
        confettiTimer = null;
        ctx.clearRect(0,0,canvas.width,canvas.height);
      }
      window.removeEventListener("resize", resizeCanvas);
    }

    // --- Mini self-tests (no rompen el juego) ---
    function selfTest(){
      try{
        console.assert(Array.isArray(phrases) && phrases.length > 10, 'phrases deber√≠a tener varias frases');
        const s = shuffle([1,2,3,4,5]);
        console.assert(s.length === 5, 'shuffle debe mantener longitud');
        picked.length = 0;
        const msg = buildFinalMessage();
        console.assert(typeof msg === 'string' && msg.includes('Isabella'), 'buildFinalMessage debe devolver texto');
      }catch(e){
        // Silencioso
      }
    }

    // Events
    btnFinal.addEventListener("click", showFinal);
    btnReset.addEventListener("click", resetGame);
    btnReset2.addEventListener("click", () => { closeFinal(); resetGame(); });
    btnClose.addEventListener("click", closeFinal);
    btnCopy.addEventListener("click", copyFinal);

    overlay.addEventListener("click", (e) => { if (e.target === overlay) closeFinal(); });

    // Init
    btnFinal.disabled = true;
    btnFinal.style.display = "none";
    renderButtons();
    updatePreview();
    burstHearts(6);
    setTimeout(()=>{ try{ showBubble('Holaaa, soy Isabella y tengo 15 üòÑüíó'); }catch(e){} }, 450);
    selfTest();
  </script>
</body>
</html>
